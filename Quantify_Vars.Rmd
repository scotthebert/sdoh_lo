---
title: "Quantify_vars"
author: "Alex Lo"
date: "2024-10-16"
output: html_document
---
<!-- Notes: -->
<!-- - Insert new section with cmd+opt+I -->
<!-- - knit with cmd+shift+k -->
<!-- comment out = cmd+ shift + c -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyverse)
library(dplyr)
#Load data
rm(list = ls())
#load in data
setwd("/Users/alo/Desktop/UMass/Capstone")
# SDOH_Data = read_csv("SDOH Data - 9_ 2024 workthrough.csv")
SDOH_Data= read_csv("SDOH FINAL 01012023 to 05312024.csv")

# Adding patient numbers --------------------------------------------------
pt_nbr=nrow(SDOH_Data) #number of patients, ID'ed by number of rows of data
pt_ID = matrix(nrow = pt_nbr, ncol = 1)
for (x in 1:pt_nbr){
  pt_ID[x] = paste("P_",x,sep = "")
}
SDOH_mtrx = cbind(pt_ID, SDOH_Data) #Master dataset with patient number included

#Set date range of appointments between 06/01/2023 and 05/31/2024
SDOH_mtrx$appt_date = as.Date(SDOH_mtrx$appt_date, format = "%m/%d/%y")
SDOH_DS = SDOH_mtrx[SDOH_mtrx$appt_date >= as.Date("06/01/23", format = "%m/%d/%y"),] #DS with correct date range
```

Quantifying Demographic
```{r}
# Quantify Race --------------------------------------------------------------------
race_tbl = table(SDOH_DS$race)
#race_prop_tbl = prop.table(race_tbl)
#colnames(race_prop_tbl) <- c("Freq")
white_row = cbind(race_tbl['White'], row.names('White'))
aa_row = cbind(race_tbl['Black or African American'], row.names('Black or African American'))
ai_row = cbind(race_tbl['American Indian or Alaska Native'], row.names('American Indian or Alaska Native'))
unreported_race = cbind(race_tbl['Unreported/Refused To Report'], row.names('Unreported/Refused To Report')) 

#Match census groups: Asian includes Chinese, Asian Indian, Other Asian
asian_ct = race_tbl['Asian'] + race_tbl['Asian Indian'] + race_tbl['Chinese'] + race_tbl['Other Asian']
asian_row = cbind(asian_ct, row.names('Asian'))

#Match census groups: Hawaiian or Other Pacific Islander
hpi_ct = race_tbl['Native Hawaiian'] + race_tbl['Other Pacific Islander'] 
hpi_row = cbind(hpi_ct, row.names('Hawaiian or Other Pacific Islander'))

#Adjusted table per census
census_tbl_rep = rbind(white_row, aa_row, ai_row, asian_row, hpi_row)
colnames(census_tbl_rep) <- c('Patients')
census_prop = prop.table(census_tbl_rep)### report this as proportion of patients

census_tbl_unrep = rbind(white_row, aa_row, ai_row, asian_row, hpi_row,unreported_race)
colnames(census_tbl_unrep) <- c('Patients')
census_prop_unrep = prop.table(census_tbl_unrep)
pct_unrep = prop.table(census_tbl_unrep)['Unreported/Refused To Report', ]### report this as proportion who did not report race

library(plotly)
race_chart <- data.frame("Race" = rownames(census_prop), census_prop)
data <- race_chart[, c('Race', 'Patients')]

#pie chart reported-----
# colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')
# fig <- plot_ly(data, labels = ~Race, values = ~Patients, type = 'pie')
# fig <- fig %>% layout(title = 'Race of patients FHCW primary care',
#                       xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
#                       yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
# 
# fig

# pie chart unreported-----
####unreported to be reported in final write up!!
race_chart <- data.frame("Race" = rownames(census_prop_unrep), census_prop_unrep) #
data <- race_chart[, c('Race', 'Patients')]
colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')
fig <- plot_ly(data, labels = ~Race, values = ~Patients, type = 'pie')
fig <- fig %>% layout(title = 'Race of patients FHCW primary care',
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

#bar chart----
# fig <- plot_ly(
#   x = rownames(census_prop),
#   y = census_prop[,1],
#   name = "Race of PT at FHCW primary care",
#   type = "bar"
# )
# 
# fig

census_prop #table of race at FHCW
pct_unrep #proportion of patients who didn't report race at FHCW

```


```{r}
# Ethnicity-------------------------------------------------------------------------
eth_tbl = as.matrix(table(SDOH_DS$ethnicity))
eth_prop_tbl = prop.table(eth_tbl)
colnames(eth_prop_tbl) <- c("Freq")

eth_df = as.data.frame(eth_tbl)
colnames(eth_df) = "Freq"
lang_nbr=nrow(eth_df)
hs_n_ct = 0
hs_y_ct = 0
hs_unrep_ct = 0

for (i in 1:lang_nbr) {
  current_row = rownames(eth_df)[i]
  if (grepl("Not Hispanic",current_row)) {
    hs_n_ct = hs_n_ct + eth_df[i, "Freq"]
  }else if (grepl("Unreported",current_row)) {
    hs_unrep_ct = hs_unrep_ct + eth_df[i, "Freq"]
  } 
  else{
    hs_y_ct = hs_y_ct + eth_df[i, "Freq"]
  }
}

hs_yn = matrix(
  c(hs_y_ct, hs_n_ct, hs_unrep_ct),
  nrow = 3,
  ncol = 1
  )
rownames(hs_yn) = c("Hispanic", "Not Hispanic", "Unreported")
colnames(hs_yn) = c("pts")


#pie chart if report hispanic or not
eth_chart <- data.frame("Ethnicity" = rownames(hs_yn), hs_yn)
data <- eth_chart[, c('Ethnicity', 'pts')]
colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')
fig <- plot_ly(data, labels = ~Ethnicity, values = ~pts, type = 'pie')
fig <- fig %>% layout(title = 'Ethnicity of patients FHCW primary care',
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

#Breakdown of hispanic-----
hl_ct = eth_tbl['Hispanic, Latino/a, Spanish Origin, Combined',] + eth_tbl['Hispanic or Latino',]
hl_row = cbind(hl_ct, row.names('Hispanic or Latino'))
cuban_row = cbind(eth_tbl['Cuban', ], row.names('Cuban'))
other_row = cbind(eth_tbl['Another Hispanic, Latino/a, or Spanish Origin', ], row.names('Another Hispanic, Latino/a, or Spanish Origin'))
pr_row = cbind(eth_tbl['Puerto Rican', ], row.names('Puerto Rican'))
mex_row = cbind(eth_tbl['Mexican, Mexican American, Chicano/a', ], row.names('Mexican, Mexican American, Chicano/a'))
hisp_tbl = rbind(hl_row, cuban_row, pr_row, mex_row, other_row)
hisp_prop = prop.table(hisp_tbl)
```

```{r}
# Gender Identity ---------------------------------------------------------
gender_tbl = as.matrix(table(SDOH_DS$gender_identity))
gender_prop_tbl = prop.table(gender_tbl)
colnames(gender_prop_tbl) <- c("Freq")

# If unreported, see current gender. If current gender and gender identity null = unreported. ----
unr_male = 0
unr_female = 0
unreported_gender = 0

for (g in 1:nrow(SDOH_DS)) {
  if (SDOH_DS$gender_identity[g] == "NULL"|SDOH_DS$gender_identity[g] == "Choose not to disclose" ) {
    if(SDOH_DS$current_gender[g] == "M"){
      unr_male = unr_male + 1 #males who did not respond to gender identity
    }else if (SDOH_DS$current_gender[g] == "F"){
      unr_female = unr_female + 1  #females who did not respond to gender identity
    }else {
      unreported_gender = unreported_gender + 1 #people who did not disclose gender identity or current gender
    }
  }
}

#
female_ct = gender_tbl['Female',] + unr_female
male_ct = gender_tbl['Male',] + unr_male

#
transgender_ct = gender_tbl['Female-to-Male (FTM)/Transgender Male/Trans Man',] + gender_tbl['Male-to-Female (MTF)/Transgender Female/Trans Woman', ]

other_gender_ct = gender_tbl['Genderqueer, neither exclusively male nor female',] + gender_tbl['Additional gender category or other, please specify', ]

#Table of reported genders, including undisclosed
gender_tbl_adj = rbind(male_ct, female_ct, transgender_ct, other_gender_row, unreported_gender)
rownames(gender_tbl_adj) <- c("Male", "Female", "Transgender", "Other", "Undisclosed")
gender_prop_adj = prop.table(gender_tbl_adj) ### report this 

```

```{r}
# language ----------------------------------------------------------------
lang_tbl = as.matrix(table(SDOH_DS$pt_language))
lang_prop_tbl = as.data.frame(prop.table(lang_tbl))
colnames(lang_prop_tbl) <- c("Freq")
other_lang = sum(lang_prop_tbl[lang_prop_tbl["Freq"] <= .02,] )

#create new table
ccat_lang = filter(lang_prop_tbl, Freq > 0.02) #if more than 1% of patients spoke language, include in new table
lang_final = rbind(ccat_lang, other_lang)
rownames(lang_final) = c(rownames(ccat_lang), "Other")

library(plotly)
lang_chart <- data.frame("Language" = rownames(lang_final), lang_final)
data <- lang_chart[, c('Language', 'Freq')]

#pie chart reported-----
colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')
fig <- plot_ly(data, labels = ~Language, values = ~Freq, type = 'pie')
fig <- fig %>% layout(title = 'Most popular languages at FHCW',
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig


```

```{r}
#age calculation
library(eeptools)
inf_ct = 0
adol_ct = 0
younga_ct = 0
mida_ct = 0
older_ct = 0
geri_ct = 0
unk_age_ct = 0
birthyr_adj = 0

for (zz in 1:pt_nbr){
  # dt_fix = sprintf("%08s", SDOH_DS$pt_dob[zz])
  # birthdate = as.Date(dt_fix, format = "%m/%d/%y")
  birthdate = as.Date(SDOH_DS$pt_dob[zz], format = "%m/%d/%y")
  birthyr = as.numeric(format(birthdate, "%Y"))
  
  #if birth year shows after 2025, adjust so it is 1900s
  if (birthyr > 2024){
    birthyr_adj = as.character(birthyr - 100)
    mmdd = format(birthdate, "%m/%d")
    birthdate_adj = paste(mmdd, birthyr_adj, sep = "/")
    birthdate = as.Date(birthdate_adj,format = "%m/%d/%y")
  }
  
  age = age_calc(birthdate, units = "years")
  if (age < 5) {
      inf_ct = inf_ct + 1
  }else if (age >= 5 && age <20 ){
      adol_ct = adol_ct + 1
  }else if (age >= 20 && age <35 ){
  younga_ct = younga_ct +1
  }else if (age >= 35 && age <50 ){
    mida_ct = mida_ct + 1
  }else if (age >= 50 && age <65 ){
    older_ct = older_ct + 1
  }else if (age >= 65 ){
    geri_ct = geri_ct + 1
  }else {
    unk_age_ct = unk_age_ct + 1
  }
}
  
```

```{r}
## Hometown --------------------------------------------
# # City ----------------------------------------------------------------
# city_tbl = as.matrix(table(SDOH_DS$city))
# city_prop_tbl = prop.table(city_tbl)
# # ZipCode -------------------------------------------------------------
# zip_tbl = as.matrix(table(SDOH_DS$zip))
# zip_prop_tbl = prop.table(city_tbl)
```

```{r}
##SDOH in last 12 months----------------------
scrnd_tbl = as.matrix(table(SDOH_DS$sdoh_within_last_12_months))
scrnd_prop_tbl = prop.table(scrnd_tbl)
```

```{r}
#Has patient been screened in the past year?---------------------------------
notutd_scrn = 0
curyr = 0
yr_scrn_mtrx = matrix(nrow = pt_nbr, ncol = 1)
for (ii in 1:pt_nbr){
  yr_scrn = as.numeric(format(as.Date(SDOH_DS$last_sdoh_complete[ii], format = "%m/%d/%y"), "%Y"))
  yr_scrn_mtrx[ii] = yr_scrn
  if (!is.na(yr_scrn)) {
    if (yr_scrn != 2023 & yr_scrn != 2024){
      notutd_scrn = notutd_scrn + 1
    }
    if (yr_scrn == 2024)
      curyr = curyr + 1 #number of patients screened in 2024 and therefore will not count in our final count
  }
}
scrn_frqtbl = as.matrix(table(yr_scrn_mtrx))
scrn_prptbl = prop.table(scrn_frqtbl)

fig <- plot_ly(
  x = rownames(scrn_prptbl),
  y = scrn_prptbl[,1],
  name = "SDOH Screening rates for 2023 pt visits",
  type = "bar"
)

fig

fig <- plot_ly(
  x = rownames(scrn_frqtbl),
  y = scrn_frqtbl[,1],
  name = "SDOH Screening #s for 2023 pt visits",
  type = "bar"
)

fig
```

```{r}
#Insurance payer----
ins_tbl = as.matrix(table(SDOH_DS$enc_payer))
ins_prop_tbl = as.data.frame(prop.table(ins_tbl))
colnames(ins_prop_tbl) <- c("Prop")
ins_prop_tbl_short = filter(ins_prop_tbl, Prop > 0.01) #if more than 1% of patients have a specific insurance, include in new table

ins_prop_tbl
```

```{r} 
#Zip----
zip_tbl = as.matrix(table(SDOH_DS$zip))
zip_prop_tbl = as.data.frame(prop.table(zip_tbl))
colnames(zip_prop_tbl) <- c("Prop")
zip_prop_tbl_short = filter(zip_prop_tbl, Prop > 0.01) #if more than 1% of patients have a specific zip, include in new table
```

```{r}
#C3 screener responses
c3_help = as.matrix(table(SDOH_DS$opt_help))
c3_housing = as.matrix(table(SDOH_DS$txt_housing_situation))
c3_livingissues_single = as.matrix(table(SDOH_DS$living))
c3_livingissues_multi = as.matrix(table(SDOH_DS$txt_living_multi))
c3_transportation = as.matrix(table(SDOH_DS$transportation))
c3_transportation_multi = as.matrix(table(SDOH_DS$transportation_multi))
c3_runoutmon4food = as.matrix(table(SDOH_DS$txt_run_out))
c3_services = as.matrix(table(SDOH_DS$txt_services))
c3_work = as.matrix(table(SDOH_DS$txt_work))
```

## Including Plots

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
